@page "/work-orders"
@attribute [Authorize]
@inject WorkOrderService WorkOrderService
@inject FilterPresetService FilterPresetService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject HttpClient HttpClient
@inject IDialogService DialogService

<PageTitle>Work Orders - Inventory Management</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Work Orders</MudText>

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudGrid>
        <!-- Filter Presets Row -->
        <MudItem xs="12">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudSelect T="FilterPresetDto"
                           Label="Filter Presets"
                           @bind-Value="_selectedPreset"
                           ValueChanged="LoadPresetAsync"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Clearable="true"
                           Style="min-width: 250px;">
                    @foreach (var preset in _filterPresets)
                    {
                        <MudSelectItem Value="@preset">
                            @preset.Name @(preset.IsDefault ? "‚≠ê" : "") @(preset.IsShared ? "üîó" : "")
                        </MudSelectItem>
                    }
                </MudSelect>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="SavePresetDialogAsync" StartIcon="@Icons.Material.Filled.Save">Save Filter</MudButton>
                @if (_selectedPreset != null)
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="DeletePresetAsync" StartIcon="@Icons.Material.Filled.Delete">Delete</MudButton>
                }
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="ClearFiltersAsync" StartIcon="@Icons.Material.Filled.Clear">Clear All</MudButton>
                <MudSpacer />
                <MudIconButton Icon="@(_showAdvancedFilters ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                               Color="Color.Primary"
                               OnClick="@(() => _showAdvancedFilters = !_showAdvancedFilters)" />
            </MudStack>
        </MudItem>

        <!-- Active Filter Chips -->
        @if (GetActiveFilterChips().Any())
        {
            <MudItem xs="12">
                <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                    <MudText Typo="Typo.caption" Class="mt-2 mr-2">Active Filters:</MudText>
                    @foreach (var chip in GetActiveFilterChips())
                    {
                        <MudChip Size="Size.Small"
                                 Color="Color.Primary"
                                 OnClose="@(() => RemoveFilterChip(chip.Key))"
                                 Text="@chip.Value" />
                    }
                </MudStack>
            </MudItem>
        }

        <!-- Basic Filters Row -->
        <MudItem xs="12" md="3">
            <MudSelect T="WorkOrderStatus?" @bind-Value="_selectedStatus" Label="Status" Variant="Variant.Outlined" Clearable="true">
                <MudSelectItem T="WorkOrderStatus?" Value="@((WorkOrderStatus?)null)">All Statuses</MudSelectItem>
                <MudSelectItem T="WorkOrderStatus?" Value="@WorkOrderStatus.Draft">Draft</MudSelectItem>
                <MudSelectItem T="WorkOrderStatus?" Value="@WorkOrderStatus.Submitted">Submitted</MudSelectItem>
                <MudSelectItem T="WorkOrderStatus?" Value="@WorkOrderStatus.Approved">Approved</MudSelectItem>
                <MudSelectItem T="WorkOrderStatus?" Value="@WorkOrderStatus.Rejected">Rejected</MudSelectItem>
                <MudSelectItem T="WorkOrderStatus?" Value="@WorkOrderStatus.InProgress">In Progress</MudSelectItem>
                <MudSelectItem T="WorkOrderStatus?" Value="@WorkOrderStatus.Completed">Completed</MudSelectItem>
                <MudSelectItem T="WorkOrderStatus?" Value="@WorkOrderStatus.Cancelled">Cancelled</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="WorkOrderPriority?" @bind-Value="_selectedPriority" Label="Priority" Variant="Variant.Outlined" Clearable="true">
                <MudSelectItem T="WorkOrderPriority?" Value="@((WorkOrderPriority?)null)">All Priorities</MudSelectItem>
                <MudSelectItem T="WorkOrderPriority?" Value="@WorkOrderPriority.Low">Low</MudSelectItem>
                <MudSelectItem T="WorkOrderPriority?" Value="@WorkOrderPriority.Medium">Medium</MudSelectItem>
                <MudSelectItem T="WorkOrderPriority?" Value="@WorkOrderPriority.High">High</MudSelectItem>
                <MudSelectItem T="WorkOrderPriority?" Value="@WorkOrderPriority.Critical">Critical</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudDatePicker @bind-Date="_fromDate" Label="From Date" Variant="Variant.Outlined" Clearable="true" />
        </MudItem>
        <MudItem xs="12" md="2">
            <MudDatePicker @bind-Date="_toDate" Label="To Date" Variant="Variant.Outlined" Clearable="true" />
        </MudItem>
        <MudItem xs="12" md="3">
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyFiltersAsync" StartIcon="@Icons.Material.Filled.Search">Search</MudButton>
                <MudMenu Label="Export" Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Download" Disabled="@_isExporting">
                    <MudMenuItem OnClick="ExportToExcelAsync" Icon="@Icons.Material.Filled.GridOn">Export to Excel</MudMenuItem>
                    <MudMenuItem OnClick="ExportToPdfAsync" Icon="@Icons.Material.Filled.PictureAsPdf">Export to PDF</MudMenuItem>
                </MudMenu>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="NavigateToCreate" StartIcon="@Icons.Material.Filled.Add">Create</MudButton>
            </MudStack>
        </MudItem>

        <!-- Advanced Filters (Collapsible) -->
        @if (_showAdvancedFilters)
        {
            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.h6" Class="mb-2">Advanced Options</MudText>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudText Typo="Typo.body2" Class="mb-1">Multi-Column Sorting</MudText>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.End">
                    <MudSelect T="string"
                               @bind-Value="_sortColumn1"
                               Label="Sort By 1"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        <MudSelectItem Value="@("")">None</MudSelectItem>
                        <MudSelectItem Value="@("OrderNumber")">Order Number</MudSelectItem>
                        <MudSelectItem Value="@("Status")">Status</MudSelectItem>
                        <MudSelectItem Value="@("Priority")">Priority</MudSelectItem>
                        <MudSelectItem Value="@("CreatedAt")">Created Date</MudSelectItem>
                        <MudSelectItem Value="@("RequestedDate")">Requested Date</MudSelectItem>
                        <MudSelectItem Value="@("CompletedDate")">Completed Date</MudSelectItem>
                    </MudSelect>
                    <MudSelect T="string" @bind-Value="_sortOrder1" Variant="Variant.Outlined" Style="max-width: 120px;">
                        <MudSelectItem Value="@("asc")">Ascending</MudSelectItem>
                        <MudSelectItem Value="@("desc")">Descending</MudSelectItem>
                    </MudSelect>
                </MudStack>
            </MudItem>

            @if (!string.IsNullOrEmpty(_sortColumn1))
            {
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.body2" Class="mb-1">&nbsp;</MudText>
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.End">
                        <MudSelect T="string"
                                   @bind-Value="_sortColumn2"
                                   Label="Then By"
                                   Variant="Variant.Outlined"
                                   Clearable="true">
                            <MudSelectItem Value="@("")">None</MudSelectItem>
                            <MudSelectItem Value="@("OrderNumber")">Order Number</MudSelectItem>
                            <MudSelectItem Value="@("Status")">Status</MudSelectItem>
                            <MudSelectItem Value="@("Priority")">Priority</MudSelectItem>
                            <MudSelectItem Value="@("CreatedAt")">Created Date</MudSelectItem>
                            <MudSelectItem Value="@("RequestedDate")">Requested Date</MudSelectItem>
                            <MudSelectItem Value="@("CompletedDate")">Completed Date</MudSelectItem>
                        </MudSelect>
                        <MudSelect T="string" @bind-Value="_sortOrder2" Variant="Variant.Outlined" Style="max-width: 120px;">
                            <MudSelectItem Value="@("asc")">Ascending</MudSelectItem>
                            <MudSelectItem Value="@("desc")">Descending</MudSelectItem>
                        </MudSelect>
                    </MudStack>
                </MudItem>
            }
        }
    </MudGrid>
</MudPaper>

@if (_isLoading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-2" />
}

<MudTable Items="@_workOrders" Hover="true" Striped="true" Dense="true" Loading="@_isLoading">
    <HeaderContent>
        <MudTh>Order Number</MudTh>
        <MudTh>Title</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>Priority</MudTh>
        <MudTh>Requested By</MudTh>
        <MudTh>Assigned To</MudTh>
        <MudTh>Requested Date</MudTh>
        <MudTh>Items</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Order Number">
            <MudLink Href="@($"/work-orders/{context.Id}")" Typo="Typo.body2" Class="font-weight-bold">
                @context.OrderNumber
            </MudLink>
        </MudTd>
        <MudTd DataLabel="Title">@context.Title</MudTd>
        <MudTd DataLabel="Status">
            <MudChip Size="Size.Small" Color="@GetStatusColor(context.Status)">@context.Status</MudChip>
        </MudTd>
        <MudTd DataLabel="Priority">
            <MudChip Size="Size.Small" Color="@GetPriorityColor(context.Priority)">@context.Priority</MudChip>
        </MudTd>
        <MudTd DataLabel="Requested By">@context.RequestedByName</MudTd>
        <MudTd DataLabel="Assigned To">@(context.AssignedToName ?? "-")</MudTd>
        <MudTd DataLabel="Requested Date">@context.RequestedDate.ToString("yyyy-MM-dd")</MudTd>
        <MudTd DataLabel="Items">@context.Items.Count item(s)</MudTd>
        <MudTd DataLabel="Actions">
            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Primary" Href="@($"/work-orders/{context.Id}")" />
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager PageSizeOptions="new int[] { 10, 20, 50, 100 }" />
    </PagerContent>
</MudTable>

<MudText Typo="Typo.body2" Class="mt-2" Color="Color.Secondary">
    Showing @_workOrders.Count of @_totalCount work orders
</MudText>

@code {
    private List<WorkOrderDto> _workOrders = new();
    private List<FilterPresetDto> _filterPresets = new();
    private FilterPresetDto? _selectedPreset = null;
    private bool _isLoading = false;
    private bool _isExporting = false;
    private bool _showAdvancedFilters = false;

    // Basic filters
    private WorkOrderStatus? _selectedStatus = null;
    private WorkOrderPriority? _selectedPriority = null;
    private DateTime? _fromDate = null;
    private DateTime? _toDate = null;

    // Sorting
    private string _sortColumn1 = "";
    private string _sortOrder1 = "desc";
    private string _sortColumn2 = "";
    private string _sortOrder2 = "asc";

    private int _currentPage = 1;
    private int _pageSize = 20;
    private int _totalCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadFilterPresetsAsync();
        await LoadDataAsync();
        
        // Set up keyboard shortcuts
        await JSRuntime.InvokeVoidAsync("eval", @"
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    document.getElementById('savePresetBtn')?.click();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('clearFiltersBtn')?.click();
                }
            });
        ");
    }

    private async Task LoadFilterPresetsAsync()
    {
        try
        {
            _filterPresets = await FilterPresetService.GetFilterPresetsAsync("WorkOrder", includeShared: true);
            
            var defaultPreset = _filterPresets.FirstOrDefault(p => p.IsDefault);
            if (defaultPreset != null)
            {
                await LoadPresetAsync(defaultPreset);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading filter presets: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadPresetAsync(FilterPresetDto preset)
    {
        if (preset == null) return;

        try
        {
            _selectedPreset = preset;
            
            var filterData = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, System.Text.Json.JsonElement>>(preset.FilterData);
            
            if (filterData != null)
            {
                if (filterData.TryGetValue("selectedStatus", out var status) && status.ValueKind != System.Text.Json.JsonValueKind.Null)
                    _selectedStatus = (WorkOrderStatus)status.GetInt32();
                else
                    _selectedStatus = null;
                
                if (filterData.TryGetValue("selectedPriority", out var priority) && priority.ValueKind != System.Text.Json.JsonValueKind.Null)
                    _selectedPriority = (WorkOrderPriority)priority.GetInt32();
                else
                    _selectedPriority = null;
                
                if (filterData.TryGetValue("fromDate", out var from) && from.ValueKind != System.Text.Json.JsonValueKind.Null)
                    _fromDate = from.GetDateTime();
                else
                    _fromDate = null;
                
                if (filterData.TryGetValue("toDate", out var to) && to.ValueKind != System.Text.Json.JsonValueKind.Null)
                    _toDate = to.GetDateTime();
                else
                    _toDate = null;
                
                if (filterData.TryGetValue("sortColumn1", out var sort1))
                    _sortColumn1 = sort1.GetString() ?? "";
                
                if (filterData.TryGetValue("sortOrder1", out var order1))
                    _sortOrder1 = order1.GetString() ?? "desc";
                
                if (filterData.TryGetValue("sortColumn2", out var sort2))
                    _sortColumn2 = sort2.GetString() ?? "";
                
                if (filterData.TryGetValue("sortOrder2", out var order2))
                    _sortOrder2 = order2.GetString() ?? "asc";
            }
            
            await ApplyFiltersAsync();
            Snackbar.Add($"Loaded preset: {preset.Name}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading preset: {ex.Message}", Severity.Error);
        }
    }

    private async Task SavePresetDialogAsync()
    {
        var parameters = new DialogParameters
        {
            ["PresetName"] = _selectedPreset?.Name ?? "",
            ["IsDefault"] = _selectedPreset?.IsDefault ?? false,
            ["IsShared"] = _selectedPreset?.IsShared ?? false
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<SaveFilterPresetDialog>("Save Filter Preset", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is Dictionary<string, object> data)
        {
            var name = data["Name"].ToString() ?? "Unnamed Preset";
            var isDefault = (bool)data["IsDefault"];
            var isShared = (bool)data["IsShared"];

            await SavePresetAsync(name, isDefault, isShared);
        }
    }

    private async Task SavePresetAsync(string name, bool isDefault, bool isShared)
    {
        try
        {
            var filterData = new
            {
                selectedStatus = _selectedStatus.HasValue ? (int)_selectedStatus.Value : (int?)null,
                selectedPriority = _selectedPriority.HasValue ? (int)_selectedPriority.Value : (int?)null,
                fromDate = _fromDate,
                toDate = _toDate,
                sortColumn1 = _sortColumn1,
                sortOrder1 = _sortOrder1,
                sortColumn2 = _sortColumn2,
                sortOrder2 = _sortOrder2
            };

            var filterDataJson = System.Text.Json.JsonSerializer.Serialize(filterData);

            if (_selectedPreset != null)
            {
                await FilterPresetService.UpdateFilterPresetAsync(_selectedPreset.Id, name, filterDataJson, isDefault, isShared);
                Snackbar.Add("Filter preset updated successfully", Severity.Success);
            }
            else
            {
                var newPreset = await FilterPresetService.CreateFilterPresetAsync(name, "WorkOrder", filterDataJson, isDefault, isShared);
                if (newPreset != null)
                {
                    _selectedPreset = newPreset;
                }
                Snackbar.Add("Filter preset saved successfully", Severity.Success);
            }

            await LoadFilterPresetsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving filter preset: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeletePresetAsync()
    {
        if (_selectedPreset == null) return;

        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete the preset '{_selectedPreset.Name}'?",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirm Delete", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                var success = await FilterPresetService.DeleteFilterPresetAsync(_selectedPreset.Id);
                if (success)
                {
                    Snackbar.Add("Filter preset deleted successfully", Severity.Success);
                    _selectedPreset = null;
                    await LoadFilterPresetsAsync();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting filter preset: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ClearFiltersAsync()
    {
        _selectedStatus = null;
        _selectedPriority = null;
        _fromDate = null;
        _toDate = null;
        _sortColumn1 = "";
        _sortOrder1 = "desc";
        _sortColumn2 = "";
        _sortOrder2 = "asc";
        _selectedPreset = null;
        
        await ApplyFiltersAsync();
    }

    private Dictionary<string, string> GetActiveFilterChips()
    {
        var chips = new Dictionary<string, string>();

        if (_selectedStatus.HasValue)
            chips.Add("status", $"Status: {_selectedStatus.Value}");

        if (_selectedPriority.HasValue)
            chips.Add("priority", $"Priority: {_selectedPriority.Value}");

        if (_fromDate.HasValue)
            chips.Add("fromDate", $"From: {_fromDate.Value:yyyy-MM-dd}");

        if (_toDate.HasValue)
            chips.Add("toDate", $"To: {_toDate.Value:yyyy-MM-dd}");

        if (!string.IsNullOrEmpty(_sortColumn1))
            chips.Add("sort", $"Sort: {_sortColumn1} ({_sortOrder1})");

        return chips;
    }

    private async Task RemoveFilterChip(string key)
    {
        switch (key)
        {
            case "status":
                _selectedStatus = null;
                break;
            case "priority":
                _selectedPriority = null;
                break;
            case "fromDate":
                _fromDate = null;
                break;
            case "toDate":
                _toDate = null;
                break;
            case "sort":
                _sortColumn1 = "";
                _sortColumn2 = "";
                break;
        }

        await ApplyFiltersAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;

        try
        {
            var queryParams = new List<string>
            {
                $"pageNumber={_currentPage}",
                $"pageSize={_pageSize}"
            };

            if (_selectedStatus.HasValue)
                queryParams.Add($"status={_selectedStatus.Value}");

            if (_selectedPriority.HasValue)
                queryParams.Add($"priority={_selectedPriority.Value}");

            if (_fromDate.HasValue)
                queryParams.Add($"fromDate={_fromDate.Value:yyyy-MM-dd}");

            if (_toDate.HasValue)
                queryParams.Add($"toDate={_toDate.Value:yyyy-MM-dd}");

            // Sorting
            var sortColumns = new List<string>();
            var sortOrders = new List<string>();

            if (!string.IsNullOrEmpty(_sortColumn1))
            {
                sortColumns.Add(_sortColumn1);
                sortOrders.Add(_sortOrder1);

                if (!string.IsNullOrEmpty(_sortColumn2))
                {
                    sortColumns.Add(_sortColumn2);
                    sortOrders.Add(_sortOrder2);
                }
            }

            if (sortColumns.Any())
            {
                queryParams.Add($"sortBy={string.Join(",", sortColumns)}");
                queryParams.Add($"sortOrder={string.Join(",", sortOrders)}");
            }

            var query = $"?{string.Join("&", queryParams)}";
            var response = await HttpClient.GetAsync($"api/v1/workorders{query}");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<PaginatedResult<WorkOrderDto>>();
                if (result != null)
                {
                    _workOrders = result.Items;
                    _totalCount = result.TotalCount;
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading work orders: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ApplyFiltersAsync()
    {
        _currentPage = 1;
        await LoadDataAsync();
    }

    private void NavigateToCreate()
    {
        NavigationManager.NavigateTo("/work-orders/create");
    }

    private async Task ExportToExcelAsync()
    {
        _isExporting = true;

        try
        {
            var queryParams = new List<string>();

            if (_selectedStatus.HasValue)
                queryParams.Add($"status={_selectedStatus.Value}");

            if (_selectedPriority.HasValue)
                queryParams.Add($"priority={_selectedPriority.Value}");

            if (_fromDate.HasValue)
                queryParams.Add($"fromDate={_fromDate.Value:yyyy-MM-dd}");

            if (_toDate.HasValue)
                queryParams.Add($"toDate={_toDate.Value:yyyy-MM-dd}");

            var query = queryParams.Any() ? $"?{string.Join("&", queryParams)}" : "";
            var response = await HttpClient.GetAsync($"api/v1/workorders/export{query}");

            if (response.IsSuccessStatusCode)
            {
                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = $"WorkOrders_{DateTime.Now:yyyyMMddHHmmss}.xlsx";

                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes));
                Snackbar.Add("Work orders exported successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting work orders: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isExporting = false;
        }
    }

    private async Task ExportToPdfAsync()
    {
        _isExporting = true;

        try
        {
            var queryParams = new List<string>();

            if (_selectedStatus.HasValue)
                queryParams.Add($"status={_selectedStatus.Value}");

            if (_selectedPriority.HasValue)
                queryParams.Add($"priority={_selectedPriority.Value}");

            if (_fromDate.HasValue)
                queryParams.Add($"fromDate={_fromDate.Value:yyyy-MM-dd}");

            if (_toDate.HasValue)
                queryParams.Add($"toDate={_toDate.Value:yyyy-MM-dd}");

            var query = queryParams.Any() ? $"?{string.Join("&", queryParams)}" : "";
            var response = await HttpClient.GetAsync($"api/v1/workorders/export/pdf{query}");

            if (response.IsSuccessStatusCode)
            {
                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = $"WorkOrders_{DateTime.Now:yyyyMMddHHmmss}.pdf";

                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes));
                Snackbar.Add("Work orders exported to PDF successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting work orders to PDF: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isExporting = false;
        }
    }

    private Color GetStatusColor(WorkOrderStatus status)
    {
        return status switch
        {
            WorkOrderStatus.Draft => Color.Default,
            WorkOrderStatus.Submitted => Color.Info,
            WorkOrderStatus.Approved => Color.Success,
            WorkOrderStatus.Rejected => Color.Error,
            WorkOrderStatus.InProgress => Color.Warning,
            WorkOrderStatus.Completed => Color.Success,
            WorkOrderStatus.Cancelled => Color.Dark,
            _ => Color.Default
        };
    }

    private Color GetPriorityColor(WorkOrderPriority priority)
    {
        return priority switch
        {
            WorkOrderPriority.Low => Color.Default,
            WorkOrderPriority.Medium => Color.Info,
            WorkOrderPriority.High => Color.Warning,
            WorkOrderPriority.Critical => Color.Error,
            _ => Color.Default
        };
    }
}
