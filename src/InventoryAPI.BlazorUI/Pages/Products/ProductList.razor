@page "/products"
@attribute [Authorize]
@inject ProductService ProductService
@inject FilterPresetService FilterPresetService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject HttpClient HttpClient

<PageTitle>Products - Inventory Management</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Products</MudText>

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudGrid>
        <!-- Filter Presets Row -->
        <MudItem xs="12">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudSelect T="FilterPresetDto"
                           Label="Filter Presets"
                           @bind-Value="_selectedPreset"
                           ValueChanged="LoadPresetAsync"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Clearable="true"
                           Style="min-width: 250px;">
                    @foreach (var preset in _filterPresets)
                    {
                        <MudSelectItem Value="@preset">
                            @preset.Name @(preset.IsDefault ? "‚≠ê" : "") @(preset.IsShared ? "üîó" : "")
                        </MudSelectItem>
                    }
                </MudSelect>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="SavePresetDialogAsync" StartIcon="@Icons.Material.Filled.Save">Save Filter</MudButton>
                @if (_selectedPreset != null)
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="DeletePresetAsync" StartIcon="@Icons.Material.Filled.Delete">Delete</MudButton>
                }
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="ClearFiltersAsync" StartIcon="@Icons.Material.Filled.Clear">Clear All</MudButton>
                <MudSpacer />
                <MudIconButton Icon="@(_showAdvancedFilters ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                               Color="Color.Primary"
                               OnClick="@(() => _showAdvancedFilters = !_showAdvancedFilters)" />
            </MudStack>
        </MudItem>

        <!-- Active Filter Chips -->
        @if (GetActiveFilterChips().Any())
        {
            <MudItem xs="12">
                <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                    <MudText Typo="Typo.caption" Class="mt-2 mr-2">Active Filters:</MudText>
                    @foreach (var chip in GetActiveFilterChips())
                    {
                        <MudChip Size="Size.Small"
                                 Color="Color.Primary"
                                 OnClose="@(() => RemoveFilterChip(chip.Key))"
                                 Text="@chip.Value" />
                    }
                </MudStack>
            </MudItem>
        }

        <!-- Basic Filters Row -->
        <MudItem xs="12" md="4">
            <MudTextField @bind-Value="_searchTerm"
                          Label="Search"
                          Placeholder="Search by SKU, name, or description"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          OnKeyUp="@((e) => { if (e.Key == "Enter") SearchAsync(); })" />
        </MudItem>
        <MudItem xs="12" md="3">
            <MudSelect @bind-Value="_selectedCategory"
                       Label="Category"
                       Variant="Variant.Outlined"
                       Clearable="true">
                <MudSelectItem Value="@("")">All Categories</MudSelectItem>
                <MudSelectItem Value="@("Widgets")">Widgets</MudSelectItem>
                <MudSelectItem Value="@("Fasteners")">Fasteners</MudSelectItem>
                <MudSelectItem Value="@("Mechanical")">Mechanical</MudSelectItem>
                <MudSelectItem Value="@("Cables")">Cables</MudSelectItem>
                <MudSelectItem Value="@("Seals")">Seals</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudCheckBox @bind-Checked="_lowStockOnly" Label="Low Stock Only" Color="Color.Warning" />
        </MudItem>
        <MudItem xs="12" md="3">
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SearchAsync" StartIcon="@Icons.Material.Filled.Search">Search</MudButton>
                <MudMenu Label="Export" Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Download" Disabled="@_isExporting">
                    <MudMenuItem OnClick="ExportToExcelAsync" Icon="@Icons.Material.Filled.GridOn">Export to Excel</MudMenuItem>
                    <MudMenuItem OnClick="ExportToPdfAsync" Icon="@Icons.Material.Filled.PictureAsPdf">Export to PDF</MudMenuItem>
                </MudMenu>
                <AuthorizeView Roles="Admin,Manager">
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" Href="/products/create" StartIcon="@Icons.Material.Filled.Add">Add Product</MudButton>
                </AuthorizeView>
            </MudStack>
        </MudItem>

        <!-- Advanced Filters (Collapsible) -->
        @if (_showAdvancedFilters)
        {
            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.h6" Class="mb-2">Advanced Filters</MudText>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudText Typo="Typo.body2" Class="mb-1">Unit Cost Range</MudText>
                <MudStack Row="true" Spacing="2">
                    <MudNumericField @bind-Value="_unitCostMin"
                                     Label="Min"
                                     Variant="Variant.Outlined"
                                     Min="0m"
                                     Format="N2"
                                     Adornment="Adornment.Start"
                                     AdornmentText="$" />
                    <MudNumericField @bind-Value="_unitCostMax"
                                     Label="Max"
                                     Variant="Variant.Outlined"
                                     Min="0m"
                                     Format="N2"
                                     Adornment="Adornment.Start"
                                     AdornmentText="$" />
                </MudStack>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudText Typo="Typo.body2" Class="mb-1">Current Stock Range</MudText>
                <MudStack Row="true" Spacing="2">
                    <MudNumericField @bind-Value="_currentStockMin"
                                     Label="Min"
                                     Variant="Variant.Outlined"
                                     Min="0" />
                    <MudNumericField @bind-Value="_currentStockMax"
                                     Label="Max"
                                     Variant="Variant.Outlined"
                                     Min="0" />
                </MudStack>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudText Typo="Typo.body2" Class="mb-1">Reorder Point Range</MudText>
                <MudStack Row="true" Spacing="2">
                    <MudNumericField @bind-Value="_reorderPointMin"
                                     Label="Min"
                                     Variant="Variant.Outlined"
                                     Min="0" />
                    <MudNumericField @bind-Value="_reorderPointMax"
                                     Label="Max"
                                     Variant="Variant.Outlined"
                                     Min="0" />
                </MudStack>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudText Typo="Typo.body2" Class="mb-1">Multi-Column Sorting</MudText>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.End">
                    <MudSelect T="string"
                               @bind-Value="_sortColumn1"
                               Label="Sort By 1"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        <MudSelectItem Value="@("")">None</MudSelectItem>
                        <MudSelectItem Value="@("Name")">Name</MudSelectItem>
                        <MudSelectItem Value="@("SKU")">SKU</MudSelectItem>
                        <MudSelectItem Value="@("Category")">Category</MudSelectItem>
                        <MudSelectItem Value="@("UnitCost")">Unit Cost</MudSelectItem>
                        <MudSelectItem Value="@("CurrentStock")">Current Stock</MudSelectItem>
                        <MudSelectItem Value="@("ReorderPoint")">Reorder Point</MudSelectItem>
                        <MudSelectItem Value="@("CreatedAt")">Created Date</MudSelectItem>
                    </MudSelect>
                    <MudSelect T="string" @bind-Value="_sortOrder1" Variant="Variant.Outlined" Style="max-width: 120px;">
                        <MudSelectItem Value="@("asc")">Ascending</MudSelectItem>
                        <MudSelectItem Value="@("desc")">Descending</MudSelectItem>
                    </MudSelect>
                </MudStack>
            </MudItem>

            @if (!string.IsNullOrEmpty(_sortColumn1))
            {
                <MudItem xs="12" md="6">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.End">
                        <MudSelect T="string"
                                   @bind-Value="_sortColumn2"
                                   Label="Then By"
                                   Variant="Variant.Outlined"
                                   Clearable="true">
                            <MudSelectItem Value="@("")">None</MudSelectItem>
                            <MudSelectItem Value="@("Name")">Name</MudSelectItem>
                            <MudSelectItem Value="@("SKU")">SKU</MudSelectItem>
                            <MudSelectItem Value="@("Category")">Category</MudSelectItem>
                            <MudSelectItem Value="@("UnitCost")">Unit Cost</MudSelectItem>
                            <MudSelectItem Value="@("CurrentStock")">Current Stock</MudSelectItem>
                            <MudSelectItem Value="@("ReorderPoint")">Reorder Point</MudSelectItem>
                            <MudSelectItem Value="@("CreatedAt")">Created Date</MudSelectItem>
                        </MudSelect>
                        <MudSelect T="string" @bind-Value="_sortOrder2" Variant="Variant.Outlined" Style="max-width: 120px;">
                            <MudSelectItem Value="@("asc")">Ascending</MudSelectItem>
                            <MudSelectItem Value="@("desc")">Descending</MudSelectItem>
                        </MudSelect>
                    </MudStack>
                </MudItem>
            }
        }
    </MudGrid>
</MudPaper>

@if (_isLoading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-2" />
}

<MudTable Items="@_products" Hover="true" Striped="true" Dense="true" Loading="@_isLoading">
    <HeaderContent>
        <MudTh>SKU</MudTh>
        <MudTh>Name</MudTh>
        <MudTh>Category</MudTh>
        <MudTh>Current Stock</MudTh>
        <MudTh>Reorder Point</MudTh>
        <MudTh>Unit Cost</MudTh>
        <MudTh>Location</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="SKU">
            <MudText Typo="Typo.body2" Class="font-weight-bold">@context.SKU</MudText>
        </MudTd>
        <MudTd DataLabel="Name">
            @context.Name
            @if (context.IsLowStock)
            {
                <MudChip Size="Size.Small" Color="Color.Warning" Class="ml-2">Low Stock</MudChip>
            }
        </MudTd>
        <MudTd DataLabel="Category">@context.Category</MudTd>
        <MudTd DataLabel="Current Stock">
            <MudText Color="@(context.IsLowStock ? Color.Warning : Color.Default)">@context.CurrentStock @context.UnitOfMeasure</MudText>
        </MudTd>
        <MudTd DataLabel="Reorder Point">@context.ReorderPoint @context.UnitOfMeasure</MudTd>
        <MudTd DataLabel="Unit Cost">$@context.UnitCost.ToString("N2")</MudTd>
        <MudTd DataLabel="Location">@context.Location</MudTd>
        <MudTd DataLabel="Actions">
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" Href="@($"/products/edit/{context.Id}")" />
            <AuthorizeView Roles="Admin">
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteProductAsync(context.Id))" />
            </AuthorizeView>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
    </PagerContent>
</MudTable>

<MudText Typo="Typo.body2" Class="mt-2" Color="Color.Secondary">
    Showing @_products.Count of @_totalCount products
</MudText>

@code {
    private List<ProductDto> _products = new();
    private List<FilterPresetDto> _filterPresets = new();
    private FilterPresetDto? _selectedPreset = null;
    private bool _isLoading = false;
    private bool _isExporting = false;
    private bool _showAdvancedFilters = false;

    // Basic filters
    private string _searchTerm = "";
    private string _selectedCategory = "";
    private bool _lowStockOnly = false;

    // Advanced filters
    private decimal? _unitCostMin = null;
    private decimal? _unitCostMax = null;
    private int? _currentStockMin = null;
    private int? _currentStockMax = null;
    private int? _reorderPointMin = null;
    private int? _reorderPointMax = null;

    // Sorting
    private string _sortColumn1 = "";
    private string _sortOrder1 = "asc";
    private string _sortColumn2 = "";
    private string _sortOrder2 = "asc";

    private int _currentPage = 1;
    private int _pageSize = 10;
    private int _totalCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadFilterPresetsAsync();
        await LoadProductsAsync();

        // Set up keyboard shortcuts
        await JSRuntime.InvokeVoidAsync("eval", @"
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    document.getElementById('savePresetBtn')?.click();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('clearFiltersBtn')?.click();
                }
            });
        ");
    }

    private async Task LoadFilterPresetsAsync()
    {
        try
        {
            _filterPresets = await FilterPresetService.GetFilterPresetsAsync("Product", includeShared: true);
            
            // Auto-load default preset if exists
            var defaultPreset = _filterPresets.FirstOrDefault(p => p.IsDefault);
            if (defaultPreset != null)
            {
                await LoadPresetAsync(defaultPreset);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading filter presets: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadPresetAsync(FilterPresetDto preset)
    {
        if (preset == null) return;

        try
        {
            _selectedPreset = preset;
            
            // Parse JSON filter data
            var filterData = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, System.Text.Json.JsonElement>>(preset.FilterData);
            
            if (filterData != null)
            {
                // Load basic filters
                if (filterData.TryGetValue("searchTerm", out var searchTerm))
                    _searchTerm = searchTerm.GetString() ?? "";
                
                if (filterData.TryGetValue("selectedCategory", out var category))
                    _selectedCategory = category.GetString() ?? "";
                
                if (filterData.TryGetValue("lowStockOnly", out var lowStock))
                    _lowStockOnly = lowStock.GetBoolean();
                
                // Load advanced filters
                if (filterData.TryGetValue("unitCostMin", out var costMin) && costMin.ValueKind != System.Text.Json.JsonValueKind.Null)
                    _unitCostMin = costMin.GetDecimal();
                else
                    _unitCostMin = null;
                
                if (filterData.TryGetValue("unitCostMax", out var costMax) && costMax.ValueKind != System.Text.Json.JsonValueKind.Null)
                    _unitCostMax = costMax.GetDecimal();
                else
                    _unitCostMax = null;
                
                if (filterData.TryGetValue("currentStockMin", out var stockMin) && stockMin.ValueKind != System.Text.Json.JsonValueKind.Null)
                    _currentStockMin = stockMin.GetInt32();
                else
                    _currentStockMin = null;
                
                if (filterData.TryGetValue("currentStockMax", out var stockMax) && stockMax.ValueKind != System.Text.Json.JsonValueKind.Null)
                    _currentStockMax = stockMax.GetInt32();
                else
                    _currentStockMax = null;
                
                if (filterData.TryGetValue("reorderPointMin", out var reorderMin) && reorderMin.ValueKind != System.Text.Json.JsonValueKind.Null)
                    _reorderPointMin = reorderMin.GetInt32();
                else
                    _reorderPointMin = null;
                
                if (filterData.TryGetValue("reorderPointMax", out var reorderMax) && reorderMax.ValueKind != System.Text.Json.JsonValueKind.Null)
                    _reorderPointMax = reorderMax.GetInt32();
                else
                    _reorderPointMax = null;
                
                // Load sorting
                if (filterData.TryGetValue("sortColumn1", out var sort1))
                    _sortColumn1 = sort1.GetString() ?? "";
                
                if (filterData.TryGetValue("sortOrder1", out var order1))
                    _sortOrder1 = order1.GetString() ?? "asc";
                
                if (filterData.TryGetValue("sortColumn2", out var sort2))
                    _sortColumn2 = sort2.GetString() ?? "";
                
                if (filterData.TryGetValue("sortOrder2", out var order2))
                    _sortOrder2 = order2.GetString() ?? "asc";
            }
            
            await SearchAsync();
            Snackbar.Add($"Loaded preset: {preset.Name}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading preset: {ex.Message}", Severity.Error);
        }
    }

    private async Task SavePresetDialogAsync()
    {
        var parameters = new DialogParameters
        {
            ["PresetName"] = _selectedPreset?.Name ?? "",
            ["IsDefault"] = _selectedPreset?.IsDefault ?? false,
            ["IsShared"] = _selectedPreset?.IsShared ?? false
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<SaveFilterPresetDialog>("Save Filter Preset", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is Dictionary<string, object> data)
        {
            var name = data["Name"].ToString() ?? "Unnamed Preset";
            var isDefault = (bool)data["IsDefault"];
            var isShared = (bool)data["IsShared"];

            await SavePresetAsync(name, isDefault, isShared);
        }
    }

    private async Task SavePresetAsync(string name, bool isDefault, bool isShared)
    {
        try
        {
            var filterData = new
            {
                searchTerm = _searchTerm,
                selectedCategory = _selectedCategory,
                lowStockOnly = _lowStockOnly,
                unitCostMin = _unitCostMin,
                unitCostMax = _unitCostMax,
                currentStockMin = _currentStockMin,
                currentStockMax = _currentStockMax,
                reorderPointMin = _reorderPointMin,
                reorderPointMax = _reorderPointMax,
                sortColumn1 = _sortColumn1,
                sortOrder1 = _sortOrder1,
                sortColumn2 = _sortColumn2,
                sortOrder2 = _sortOrder2
            };

            var filterDataJson = System.Text.Json.JsonSerializer.Serialize(filterData);

            if (_selectedPreset != null)
            {
                // Update existing preset
                await FilterPresetService.UpdateFilterPresetAsync(_selectedPreset.Id, name, filterDataJson, isDefault, isShared);
                Snackbar.Add("Filter preset updated successfully", Severity.Success);
            }
            else
            {
                // Create new preset
                var newPreset = await FilterPresetService.CreateFilterPresetAsync(name, "Product", filterDataJson, isDefault, isShared);
                if (newPreset != null)
                {
                    _selectedPreset = newPreset;
                }
                Snackbar.Add("Filter preset saved successfully", Severity.Success);
            }

            await LoadFilterPresetsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving filter preset: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeletePresetAsync()
    {
        if (_selectedPreset == null) return;

        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete the preset '{_selectedPreset.Name}'?",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirm Delete", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                var success = await FilterPresetService.DeleteFilterPresetAsync(_selectedPreset.Id);
                if (success)
                {
                    Snackbar.Add("Filter preset deleted successfully", Severity.Success);
                    _selectedPreset = null;
                    await LoadFilterPresetsAsync();
                }
                else
                {
                    Snackbar.Add("Failed to delete filter preset", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting filter preset: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ClearFiltersAsync()
    {
        _searchTerm = "";
        _selectedCategory = "";
        _lowStockOnly = false;
        _unitCostMin = null;
        _unitCostMax = null;
        _currentStockMin = null;
        _currentStockMax = null;
        _reorderPointMin = null;
        _reorderPointMax = null;
        _sortColumn1 = "";
        _sortOrder1 = "asc";
        _sortColumn2 = "";
        _sortOrder2 = "asc";
        _selectedPreset = null;
        
        await SearchAsync();
    }

    private async Task LoadProductsAsync()
    {
        _isLoading = true;

        try
        {
            var queryParams = new List<string>
            {
                $"pageNumber={_currentPage}",
                $"pageSize={_pageSize}"
            };

            // Basic filters
            if (!string.IsNullOrWhiteSpace(_selectedCategory))
                queryParams.Add($"category={Uri.EscapeDataString(_selectedCategory)}");

            if (!string.IsNullOrWhiteSpace(_searchTerm))
                queryParams.Add($"searchTerm={Uri.EscapeDataString(_searchTerm)}");

            if (_lowStockOnly)
                queryParams.Add("lowStockOnly=true");

            // Advanced filters
            if (_unitCostMin.HasValue)
                queryParams.Add($"unitCostMin={_unitCostMin.Value}");

            if (_unitCostMax.HasValue)
                queryParams.Add($"unitCostMax={_unitCostMax.Value}");

            if (_currentStockMin.HasValue)
                queryParams.Add($"currentStockMin={_currentStockMin.Value}");

            if (_currentStockMax.HasValue)
                queryParams.Add($"currentStockMax={_currentStockMax.Value}");

            if (_reorderPointMin.HasValue)
                queryParams.Add($"reorderPointMin={_reorderPointMin.Value}");

            if (_reorderPointMax.HasValue)
                queryParams.Add($"reorderPointMax={_reorderPointMax.Value}");

            // Sorting
            var sortColumns = new List<string>();
            var sortOrders = new List<string>();

            if (!string.IsNullOrEmpty(_sortColumn1))
            {
                sortColumns.Add(_sortColumn1);
                sortOrders.Add(_sortOrder1);

                if (!string.IsNullOrEmpty(_sortColumn2))
                {
                    sortColumns.Add(_sortColumn2);
                    sortOrders.Add(_sortOrder2);
                }
            }

            if (sortColumns.Any())
            {
                queryParams.Add($"sortBy={string.Join(",", sortColumns)}");
                queryParams.Add($"sortOrder={string.Join(",", sortOrders)}");
            }

            var query = $"?{string.Join("&", queryParams)}";
            var response = await HttpClient.GetAsync($"api/v1/products{query}");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<PaginatedResult<ProductDto>>();
                if (result != null)
                {
                    _products = result.Items;
                    _totalCount = result.TotalCount;
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading products: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SearchAsync()
    {
        _currentPage = 1;
        await LoadProductsAsync();
    }

    private Dictionary<string, string> GetActiveFilterChips()
    {
        var chips = new Dictionary<string, string>();

        if (!string.IsNullOrWhiteSpace(_searchTerm))
            chips.Add("searchTerm", $"Search: {_searchTerm}");

        if (!string.IsNullOrWhiteSpace(_selectedCategory))
            chips.Add("category", $"Category: {_selectedCategory}");

        if (_lowStockOnly)
            chips.Add("lowStock", "Low Stock Only");

        if (_unitCostMin.HasValue)
            chips.Add("costMin", $"Min Cost: ${_unitCostMin.Value:N2}");

        if (_unitCostMax.HasValue)
            chips.Add("costMax", $"Max Cost: ${_unitCostMax.Value:N2}");

        if (_currentStockMin.HasValue)
            chips.Add("stockMin", $"Min Stock: {_currentStockMin.Value}");

        if (_currentStockMax.HasValue)
            chips.Add("stockMax", $"Max Stock: {_currentStockMax.Value}");

        if (_reorderPointMin.HasValue)
            chips.Add("reorderMin", $"Min Reorder: {_reorderPointMin.Value}");

        if (_reorderPointMax.HasValue)
            chips.Add("reorderMax", $"Max Reorder: {_reorderPointMax.Value}");

        if (!string.IsNullOrEmpty(_sortColumn1))
            chips.Add("sort", $"Sort: {_sortColumn1} ({_sortOrder1})");

        return chips;
    }

    private async Task RemoveFilterChip(string key)
    {
        switch (key)
        {
            case "searchTerm":
                _searchTerm = "";
                break;
            case "category":
                _selectedCategory = "";
                break;
            case "lowStock":
                _lowStockOnly = false;
                break;
            case "costMin":
                _unitCostMin = null;
                break;
            case "costMax":
                _unitCostMax = null;
                break;
            case "stockMin":
                _currentStockMin = null;
                break;
            case "stockMax":
                _currentStockMax = null;
                break;
            case "reorderMin":
                _reorderPointMin = null;
                break;
            case "reorderMax":
                _reorderPointMax = null;
                break;
            case "sort":
                _sortColumn1 = "";
                _sortColumn2 = "";
                break;
        }

        await SearchAsync();
    }

    private async Task DeleteProductAsync(Guid id)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = "Are you sure you want to delete this product? This action cannot be undone.",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirm Delete", parameters, options);
        var dialogResult = await dialog.Result;

        if (!dialogResult.Canceled)
        {
            try
            {
                var success = await ProductService.DeleteProductAsync(id);
                if (success)
                {
                    Snackbar.Add("Product deleted successfully", Severity.Success);
                    await LoadProductsAsync();
                }
                else
                {
                    Snackbar.Add("Failed to delete product", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting product: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ExportToExcelAsync()
    {
        _isExporting = true;

        try
        {
            var queryParams = new List<string>();

            if (!string.IsNullOrWhiteSpace(_selectedCategory))
                queryParams.Add($"category={Uri.EscapeDataString(_selectedCategory)}");

            if (!string.IsNullOrWhiteSpace(_searchTerm))
                queryParams.Add($"searchTerm={Uri.EscapeDataString(_searchTerm)}");

            if (_lowStockOnly)
                queryParams.Add("lowStockOnly=true");

            var query = queryParams.Any() ? $"?{string.Join("&", queryParams)}" : "";
            var response = await HttpClient.GetAsync($"api/v1/products/export{query}");

            if (response.IsSuccessStatusCode)
            {
                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = $"Products_{DateTime.Now:yyyyMMddHHmmss}.xlsx";

                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes));
                Snackbar.Add("Products exported successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to export products", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting products: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isExporting = false;
        }
    }

    private async Task ExportToPdfAsync()
    {
        _isExporting = true;

        try
        {
            var queryParams = new List<string>();

            if (!string.IsNullOrWhiteSpace(_selectedCategory))
                queryParams.Add($"category={Uri.EscapeDataString(_selectedCategory)}");

            if (!string.IsNullOrWhiteSpace(_searchTerm))
                queryParams.Add($"searchTerm={Uri.EscapeDataString(_searchTerm)}");

            if (_lowStockOnly)
                queryParams.Add("lowStockOnly=true");

            var query = queryParams.Any() ? $"?{string.Join("&", queryParams)}" : "";
            var response = await HttpClient.GetAsync($"api/v1/products/export/pdf{query}");

            if (response.IsSuccessStatusCode)
            {
                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = $"Products_{DateTime.Now:yyyyMMddHHmmss}.pdf";

                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes));
                Snackbar.Add("Products exported to PDF successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to export products to PDF", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting products to PDF: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isExporting = false;
        }
    }
}
